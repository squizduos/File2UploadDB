pipeline:
    telegram-notify-start-build:
        image: appleboy/drone-telegram
        secrets:
          - telegram_token
        to: 
         - 57439615
        message: >
            Начинаем собирать {{repo.name}} ветка  [#{{build.number}}]({{build.link}})
        when:
            branch: master

    build:
        image: docker/compose:1.9.0
        commands:
         - docker-compose build
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
        when:
            branch: master
    
    telegram-notify-start-deploy:
        image: appleboy/drone-telegram
        secrets:
          - telegram_token
        to: 
         - 57439615
        message: >
            Внимание! В ближайшие 20 секунд сервис [img-test](http://img-test.squizduos.ru) может быть недоступен. Приносим свои извинения.
        when:
            branch: master
            status:  [ success ]

    deploy-local:
        image: docker/compose:1.9.0
        commands:
          - docker-compose up -d
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
        when:
            branch: master
            status:  [ success ]
    
    telegram-notify-deploy-finished:
        image: appleboy/drone-telegram
        secrets:
          - telegram_token
        to: 
         - 57439615
        message: >
            {{#success build.status}}
            Сборка проекта {{repo.name}} - {{commit.branch}} rev.{{build.number}} успешно завершена.
            Сборка проекта шла с {{datetime build.started "15:04:05" "GMT+3"}} по {{datetime build.finished "15:04:05" "GMT+3"}} {{datetime build.finished "01.02.2006" "GMT+3"}} г.
            Детальный лог доступен по [ссылке]({{build.link}}).
            Сервис возобновил свою работу на [http://img-test.squizduos.ru](http://img-test.squizduos.ru).
            {{else}}
            Сборка проекта {{repo.name}} - {{commit.branch}} rev.{{build.number}} не удалась.
            Виновник торжества - {{commit.author}}.
            Детальный лог доступен по [ссылке]({{build.link}}). 
            Сервис продолжает работу в стабильном режиме по адресу [http://img-test.squizduos.ru](http://img-test.squizduos.ru).
            {{/success}}
        when:
            branch: master
            status:  [ failure, success ]

